```{r iterative-setup, include = FALSE}
knitr::opts_chunk$set(fig.path = "figures/")
library(tidymodels)
library(finetune)
library(doMC)
registerDoMC(cores = parallel::detectCores(logical = TRUE))

## -----------------------------------------------------------------------------

data(cells)
cells <- cells %>% select(-case)
set.seed(33)
cell_folds <- vfold_cv(cells)
roc_res <- metric_set(roc_auc)
```

# Iterative search {#iterative-search}


```{r iterative-svm-defs}
svm_rec <- 
  recipe(class ~ ., data = cells) %>%
  step_YeoJohnson(all_predictors()) %>%
  step_normalize(all_predictors())

svm_spec <- 
 svm_rbf(cost = tune(), rbf_sigma = tune()) %>% 
 set_engine("kernlab") %>% 
 set_mode("classification")

svm_wflow <- 
  workflow() %>% 
  add_model(svm_spec) %>% 
  add_recipe(svm_rec)

svm_param <- 
 svm_wflow %>% 
 parameters() %>% 
  update(
    cost = cost(c(-10, 5)),
    rbf_sigma = rbf_sigma(c(-7, -1))
  )
```

```{r iterative-roc-surface, out.width = "80%", echo = FALSE, warning = FALSE}
# See file extras/cells_svm_large.R
res <- file.copy("premade/roc_surface.png", "_book/premade/roc_surface.png")
knitr::include_graphics("premade/roc_surface.png")
```

```{r iterative-svm-initial, cache = TRUE}
set.seed(234)
start_grid <- 
 svm_param %>% 
 update(
  cost = cost(c(-6, 1)),
  rbf_sigma = rbf_sigma(c(-6, -4))
 ) %>% 
 grid_regular(levels = 2)

set.seed(2)
svm_initial <- 
  svm_wflow %>% 
  tune_grid(resamples = cell_folds, grid = start_grid, metrics = roc_res)

collect_metrics(svm_initial)
```



## Bayesian  optimization


```{r iterative-cells-bo-calcs, echo = FALSE, cache = TRUE}
ctrl <- control_bayes(no_improve = Inf, verbose = TRUE)

sa_output <- capture.output({
  set.seed(55)
  svm_bo <-
    svm_wflow %>%
    tune_bayes(
      resamples = cell_folds,
      metrics = roc_res,
      initial = svm_initial,
      param_info = svm_param,
      iter = 25,
      control = ctrl
    )
}, 
type = "output")
```

```{r iterative-cells-bo, eval = FALSE}
ctrl <- control_bayes(no_improve = Inf, verbose = TRUE)

set.seed(55)
svm_bo <-
 svm_wflow %>%
 tune_bayes(
  resamples = cell_folds,
  metrics = roc_res,
  initial = svm_initial,
  param_info = svm_param,
  iter = 25,
  control = ctrl
 )
```
```{r iterative-cells-bo-print-first, echo = FALSE}
so_stop <- "Iteration 3"
so_stop_index <- grep(so_stop, sa_output) 
if (length(so_stop_index) > 0) {
  cat(sa_output[1:(so_stop_index - 2)], sep = "\n")
}
```

```{r iterative-cells-bo-print-impr, echo = FALSE}
all_imp_index <- grep("â™¥", sa_output)
so_stop_index <- all_imp_index[length(all_imp_index)]
if (length(all_imp_index) > 0) {
  so_start_index <- so_stop_index - 11
  cat(sa_output[so_start_index:(so_stop_index + 1)], sep = "\n")
}
```

```{r iterative-cells-bo-print-last, echo = FALSE}
so_start <- "Iteration 25"
so_start_index <- grep(so_start, sa_output)
if (length(so_start_index) > 0) {
  cat(sa_output[so_start_index:length(sa_output)], sep = "\n")
}
```


```{r echo = FALSE, eval = FALSE}
# remotes::install_github("tidymodels/tune@testing-gp")
initial_points <-
 svm_initial %>% 
 collect_metrics() %>% 
 filter(.metric == "roc_auc")

bo_bound_points <-
 svm_bo %>%
 collect_metrics() %>%
 filter(.metric == "roc_auc" & .iter > 0) %>%
 arrange(.iter)

save(initial_points, bo_bound_points, file = "~/tmp/gp_test/other.RData")
```

```{r iterative-bo-iter, fig.height = 4}
autoplot(svm_bo, type = "performance")
```


```{r iterative-bo-progress, out.width = "100%", echo = FALSE, warning = FALSE}
res <- file.copy("premade/exp_improve.gif", "_book/premade/exp_improve.gif")
knitr::include_graphics("premade/exp_improve.gif")
```


## Simulated annealing 

```{r iterative-cells-sa-calcs, include = FALSE, cache = TRUE}
ctrl_sa <- control_sim_anneal(no_improve = Inf, radius = 0.1)

sa_output <- capture.output({
  set.seed(123)
  svm_sa <-
    svm_wflow %>%
    tune_sim_anneal(
      resamples = cell_folds,
      metrics = roc_res,
      initial = svm_initial,
      param_info = svm_param,
      iter = 50,
      control = ctrl_sa
    )
}, 
type = "message")
```
```{r iterative-cells-sa, eval = FALSE}
ctrl_sa <- control_sim_anneal(no_improve = Inf, radius = 0.1)

sa_output <- capture.output({
  set.seed(123)
  svm_sa <-
    svm_wflow %>%
    tune_sim_anneal(
      resamples = cell_folds,
      metrics = roc_res,
      initial = svm_initial,
      param_info = svm_param,
      iter = 50,
      control = ctrl_sa
    )
})
```



