```{r introduction-setup, include = FALSE}
knitr::opts_chunk$set(fig.path = "figures/")
library(tidymodels)
library(AmesHousing)
library(doMC)

ames <- make_ames()

set.seed(833961)
ames_split <- initial_split(ames, prob = 0.80, strata = Sale_Price)
ames_train <- training(ames_split)
ames_test  <-  testing(ames_split)
set.seed(1352)
ames_folds <- vfold_cv(ames_train, v = 10)

registerDoMC(cores = parallel::detectCores())

load("RData/rf_resampled.RData")

keep_pred <- control_resamples(save_pred = TRUE)
```

# Comparing models with resampling {#compare}


```{r compare-lin-reg}
ames_rec <- 
  recipe(Sale_Price ~ Neighborhood + Gr_Liv_Area + Year_Built + Bldg_Type + 
           Latitude + Longitude, data = ames_train) %>%
  step_log(Sale_Price, base = 10)%>%
  step_log(Gr_Liv_Area, base = 10) %>% 
  step_other(Neighborhood, threshold = 0.01) %>% 
  step_dummy(all_nominal()) %>% 
  step_interact(~ Gr_Liv_Area:starts_with("Bldg_Type_")) %>% 
  step_ns(Latitude, Longitude, deg_free = 20)

lm_wflow <- 
  workflow() %>% 
  add_recipe(ames_rec) %>% 
  add_model(linear_reg() %>% set_engine("lm"))

lm_res <- 
  lm_wflow %>% 
  fit_resamples(resamples = ames_folds, control = keep_pred)
lm_res
```

```{r compare-collect}
lm_rmse <- 
  collect_metrics(lm_res, summarize = FALSE) %>% 
  filter(.metric == "rmse") %>% 
  select(id, `linear regression` = .estimate)

rf_rmse <- 
  collect_metrics(rf_res, summarize = FALSE) %>% 
  filter(.metric == "rmse") %>% 
  select(id, `random forest` = .estimate)  

rmse_estimates <- inner_join(lm_rmse, rf_rmse, by = "id")
rmse_estimates

cor.test(rmse_estimates$`linear regression`, 
         rmse_estimates$`random forest`) %>% 
  tidy() %>% 
  select(estimate, starts_with("conf"))
```


```{r compare-rmse-plot}
rmse_estimates %>% 
  pivot_longer(cols = c(-id), names_to = "model", values_to = "rmse") %>% 
  ggplot(aes(x = model, y = rmse, group = id, col = id)) + 
  geom_line(alpha = .5, lwd = 1.25) + 
  theme(legend.position = "none")
```


## Simple hypothesis testing methods

```{r compare-t-test}
t.test(rmse_estimates$`linear regression`, 
       rmse_estimates$`random forest`, 
       paired = TRUE) %>%
  tidy()
```
